---
title: "The YAML Fieldguide"
output: 
  prettydoc::html_pretty:
    theme: tactile
vignette: >
  %\VignetteIndexEntry{The YAML Fieldguide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  collapse = TRUE,
  comment = ""
)
```

```{r setup}
library(ymlthis)
```

```{r}
function_name <- function(x) {
  function_call <- as.character(attr(x, "call"))
  ifelse(rlang::has_length(function_call), function_call[[2]], NA)
}

get_doc_name <- function(x) {
  doc_name <- x[["rdname"]]
  if (is.null(doc_name)) doc_name <- function_name(x)
  doc_name
}

get_params <- function(x) {
  param_lists <- which(names(x) == "param")
  f <- get_doc_name(x)
  if (!rlang::has_length(param_lists) || is.na(f)) return(data.frame())
  
  params_desc <- x[param_lists] %>% 
    purrr::map_df(as.data.frame, stringsAsFactors = FALSE)
  
  params_desc$description <- stringr::str_replace_all(
    params_desc$description, 
    "\n", 
    " "
  )
  
  params_desc$name <- stringr::str_replace_all(
    params_desc$name,
    ",",
    ", "
  )
  
  cbind(func = f, params_desc, stringsAsFactors = FALSE)
}

link_help_page <- function(x) {
  glue::glue("<a href='https://rstudio-education.github.io/ymlthis/reference/{x}.html'>{x}</a>")
} 

filter_kable <- function(.tbl, .pattern = NULL, caption = NULL) {
  if (!is.null(.pattern)) {
    index <- stringr::str_detect(.tbl$func, .pattern)
    .tbl <- .tbl[index, ]
  }
  .tbl$func <- link_help_page(.tbl$func)
  
  knitr::kable(
    .tbl, 
    col.names = c("Help Page", "Argument", "Description"), 
    row.names = FALSE, 
    caption = caption
  )
}

fields_df <- roxygen2::parse_package("../") %>% 
  purrr::map_df(get_params)

empty_yaml <- function() yml(get_yml = FALSE, author = FALSE, date = FALSE)
```

# YAML: An overview
## Basic syntax

The basic syntax of YAML is to use key-value pairs in the format `key: value`. A YAML code block should be fenced in with `---` before and after (you can also use `...` to end the YAML block, but this is not very common in R Markdown).

```{r}
yml(date = FALSE)
```

In R, the equivalent structure is a list with named character vector: `list(author = "Malcolm Barrett")`. In fact, you can call this list in R Markdown using the `metadata` object: `metadata$author` will return the YAML in the metadata header. 

In YAML, spaces are used to indicate nesting. When we want to specify the output function `pdf_document(toc = TRUE)`, we need to nest it under the `output` field. We also need to nest `toc` under `pdf_document` so that it gets passed to that function correctly.

```{r}
empty_yaml() %>% 
  yml_output(pdf_document(toc = TRUE))
```

In R, the equivalent structure is a nested list, each with a name: `list(output = list(pdf_document = list(toc = TRUE)))`. Similarly, you can call this in R Markdown using the `metadata` object, e.g. `metadata$output$pdf_document$toc`. The hierarchical structure (which you can see with `draw_yml_tree()`) looks like this:

```{r}
empty_yaml() %>% 
  yml_output(pdf_document(toc = TRUE)) %>% 
  draw_yml_tree()
```

Without the extra indents, YAML doesn't know `toc` is connected to `pdf_document` and thinks the value of `pdf_document` is `NULL`:

```{r}
list(output = list(pdf_document = NULL), toc = TRUE) %>% 
  as_yml() %>% 
  draw_yml_tree()
```


If you use output functions without additional arguments, the value of `output` can simply be the name of the function. 

```{r}
empty_yaml() %>% 
  yml_output(html_document())
```

However, if you're specifying more than one output type, you must use the nesting syntax. If you don't want to include additional arguments, use `"default"` as the function's value.

```{r}
empty_yaml() %>% 
  yml_output(html_document(), pdf_document(toc = TRUE))
```

Some YAML fields take unnamed vectors as their value. You can specify an element of the vector by adding a new line and `-` (note that the values are not indented below `category` here).

```{r}
empty_yaml() %>% 
  yml_category(c("R", "Reprodicible Research"))
```

In R, the equivalent structure is a list with a named vector: `list(categories = c("R", "Reprodicible Research"))`. `metadata$category` will return `c("R", "Reprodicible Research")`. Another way to specify vectors is to use `[]` with each object separated by a column, as in the syntax for `c()`. This YAML is equivalent to the YAML above:

```yaml
---
category: [R, Reprodicible Research]
---
```

By default, ymlthis uses the `-` syntax for vectors. You also see `-` used to group elements together. For instance, in the `params` field for parameterized reports, we give . While you can use `metadata` to call objects in `params`, `params` has it's own object you can call directly: `params$a` and `params$data` will return the values of `a` and `data`.

```{r}
empty_yaml() %>% 
  yml_params(
    list(a = 1, input = "numeric"), 
    list(data = "data.csv", input = "text")
  )
```


In R, the equivalent structure is a nested list that contains a list of unnamed lists: `list(param = list(list(a = 1, input = numeric), list(data = "data.csv", input = "file")))`. The inner-most lists group items together, e.g. `list(a = 1, input = numeric)` groups `a` and `input`.

```{r}
empty_yaml() %>% 
  yml_params(
    list(a = 1, input = "numeric"), 
    list(data = "data.csv", input = "text")
  ) %>% 
  draw_yml_tree()
```

## Types in YAML

You may have noticed that strings in YAML don't always need to be quoted. However, it can be useful to explicitly wrap strings in quotes when they contain special characters like `:` and `@`.

```{r}
empty_yaml() %>% 
  yml_title("R Markdown: An Introduction")
```

R code can be written as inline expressions `` `r knitr::inline_expr('expr')` ``. `yml_code()` will capture R code for you and put it in a valid format. R code in `params` needs to be slightly different: use `!r` (e.g. `!r expr`) to call an R object.

```yaml
author: '`r knitr::inline_expr('whoami::fullname()')`'
params:
  date: !r Sys.Date()
```

Logical values in YAML are unusual: `true/false`, `yes/no`, and `on/off` are all equivalent to `TRUE/FALSE` in R. Any of these turn on the table of contents:

```yaml
toc: true
toc: yes
toc: on
```

By default, ymlthis uses `true/false`. If you want to use any of these values literally (e.g. you want a string equal to `"yes"`), you need to quote them as a string:

```{r}
empty_yaml() %>% 
  yml_params(x = "yes")
```

`NULL` can be specified using `null` or `~`. By default, ymlthis uses `null`. If you want to specify an empty vector, use `[]`, e.g. `category: []`. For an empty string, just use `""`.

## Sources of YAML

Where do the YAML fields you use in R Markdown come from? Many YAML fields that we use come from Pandoc and R Markdown. These both use YAML to specify the build of the document and to pass information to be printed in a template. Pandoc templates can also be customized to add new YAML. The most common sources of YAML are:

1. Pandoc
1. R Markdown
1. Output functions (such as `rmarkdown::pdf_document()`)
1. Custom Pandoc templates
1. R Markdown extension packages (such as blogdown)
1. Hugo (in the case of blogdown)

Because YAML is an extensible approach to metadata, and there is often no way to validate that your YAML is correct. YAML will often fail silently if you, for instance, make a typo in the field name or misspecify the nesting between fields. 

# Fieldguide

ymlthis attempts to write common YAML for you in the right way and to document the many YAML field options in one place. The fieldguide is a collection of all the fields documented in the ymlthis help pages, organized by source. Note that some argument names do not match the YAML field name exactly in order because not all field names are valid R names (e.g. the `link-citations` YAML field needs to be `link_citations` in R); these differences are noted in the argument description. Additionally, not all of these arguments are top-level YAML; see the linked help pages for more details.

## Basic YAML

```{r}
fields_df %>% 
  filter_kable("yml_author|yml_runtime|yml_clean", caption = "Basic YAML")
```

The nested fields for the `output` field are based on the arguments of the output function. See the help page for the function you are using, e.g., `?rmarkdown::pdf_document`.

## Pandoc Options

```{r}
fields_df %>% 
  filter_kable("latex|html|word", caption = "Pandoc Options")
```

## R Markdown Websites

```{r}
fields_df %>% 
  filter_kable("site|navbar|vignette", caption = "R Markdown Websites")
```

## Citations

```{r}
fields_df %>% 
  filter_kable("citations", caption = "Citations")
```

## blogdown YAML

```{r}
fields_df %>% 
  filter_kable("blogdown", caption = "blogdown YAML")
```

## bookdown YAML

```{r}
fields_df %>% 
  filter_kable("bookdown", caption = "bookdown YAML")
```

## pkgdown YAML

```{r}
fields_df %>% 
  filter_kable("pkgdown", caption = "pkgdown YAML")
```

## pagedown YAML

```{r}
fields_df %>% 
  filter_kable("pagedown", caption = "pagedown YAML")
```

## distill YAML

```{r}
fields_df %>% 
  filter_kable("distill", caption = "distill YAML")
```

## rticles YAML

```{r}
fields_df %>% 
  filter_kable("rticles", caption = "rticles YAML")
```

## RStudio Connect Scheduled Email YAML

```{r}
fields_df %>% 
  filter_kable("rsconnect", caption = "RStudio Connect Scheduled Email YAML")
```
